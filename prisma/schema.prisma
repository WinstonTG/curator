// Curator Database Schema
// Preference Graph + Items + Analytics

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Seed script
// Run: npx prisma db seed

// ========================================
// User & Authentication
// ========================================

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  display_name   String
  avatar_url     String?
  password_hash  String?  // Nullable for OAuth-only accounts
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  last_login     DateTime?

  // OAuth providers (stored as JSON array)
  oauth_providers Json @default("[]") // ["spotify", "google"]

  // Relations
  interests        Interest[]
  constraints      Constraint[]
  vectors          PreferenceVector[]
  interactions     InteractionHistory[]

  @@map("users")
}

// ========================================
// Preference Graph
// ========================================

model Interest {
  id         String   @id @default(uuid())
  user_id    String
  domain     String   // music, news, recipes, learning, events
  type       String   // genre, artist, topic, cuisine, etc.
  value      String   // The actual interest value
  weight     Float    @default(0.5) // 0-1 strength
  source     String   // explicit, inferred, imported
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, domain])
  @@index([user_id, type])
  @@map("interests")
}

model Constraint {
  id         String   @id @default(uuid())
  user_id    String
  domain     String   // music, news, recipes, learning, events
  type       String   // dietary_restriction, allergen, block_publication, etc.
  value      String   // The constraint value
  reason     String?  // Optional explanation
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, domain])
  @@index([user_id, type])
  @@map("constraints")
}

model PreferenceVector {
  id         String   @id @default(uuid())
  user_id    String
  domain     String   // Domain-specific embedding
  vector     Json     // Array of 1536 floats (stored as JSON)

  // Metadata about vector generation
  generated_from Json  // Array of interest/constraint IDs used
  last_updated   DateTime @default(now())
  version        Int @default(1)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, domain])
  @@map("preference_vectors")
}

// ========================================
// Interaction History
// ========================================

model InteractionHistory {
  id        String   @id @default(uuid())
  user_id   String
  item_id   String   // Reference to recommended item (may be external ID)
  domain    String
  action    String   // viewed, saved, tried, attended, purchased, dismissed
  feedback  String?  // liked, disliked, irrelevant

  // Context when interaction happened
  context   Json?    // { time_of_day, weather, location }

  timestamp DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, domain])
  @@index([user_id, action])
  @@index([timestamp])
  @@map("interaction_history")
}

// ========================================
// Items (Recommendations)
// ========================================

model Item {
  id          String   @id @default(uuid())
  domain      String
  title       String
  description String?  @db.Text

  // Source information
  source_name String
  source_id   String
  source_url  String?
  reputation_score Int?

  // Embeddings for semantic search
  embeddings  Json?    // Array of 1536 floats

  // Topics/tags
  topics      Json     // Array of strings

  // Available actions
  actions     Json     // Array of strings: save, try, attend, purchase

  // Sponsorship
  sponsored   Boolean  @default(false)

  // Domain-specific metadata
  meta        Json     // Domain-specific fields (varies by domain)

  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([domain])
  @@index([source_name, source_id])
  @@map("items")
}

// ========================================
// Analytics Events
// ========================================

model AnalyticsEvent {
  id         String   @id @default(uuid())
  event      String   // session_started, recommendation_viewed, etc.
  user_id    String?
  session_id String?

  // Event properties (varies by event type)
  properties Json

  timestamp  DateTime @default(now())

  @@index([event])
  @@index([user_id])
  @@index([session_id])
  @@index([timestamp])
  @@map("analytics_events")
}
